#cloud-config
<%#
kind: provision
name: CoreOS provision
oses:
- CoreOS
%>
coreos:
  units:
    - name: coreos-bootstrap.service
      runtime: no
      command: start
      content: |
        [Unit]
        Description=Install coreos to disk
        [Service]
        ExecStart=/home/core/install-and-reboot.sh
        [X-Fleet]
        X-Conflicts=coreos-bootstrap.service
<% if @host.params['ssh_authorized_keys'] -%>
ssh_authorized_keys:
<% @host.params['ssh_authorized_keys'].split(',').map(&:strip).each do |ssh_key| -%>
  - "<%= ssh_key %>"
<% end -%>
<% else -%>
users:
  - name: core
    passwd: <%= root_pass %>
<% end -%>
write_files:
  - path: /home/core/cloud-config.yml
    permissions: '0600'
    owner: core:core
    content: |
      <%= snippet 'STI-IT coreos_cloudconfig' %>
  - path: /home/core/install-and-reboot.sh
    permissions: '0755'
    owner: core:core
    content: |
      #!/bin/bash
      
      set -e -x

      # Zap all volume groups, lest coreos-install fail to BLKRRPART
      # (https://github.com/coreos/bugs/issues/152)

      vgs --noheadings 2>/dev/null | awk '{ print $1}' | xargs -n 1 vgremove -f || true

      /usr/bin/coreos-install -C  <%= @host.operatingsystem.release_name %> -d <%= @host.params['install-disk'] || '/dev/sda' %> -c /home/core/cloud-config.yml <% if @host.operatingsystem.major >= "557" -%>-b <%= @mediapath %><% end -%>

      # Run Puppet once before rebooting, so as to get a certificate while
      # Foreman lets Puppet autosign (that time window closes at the same
      # time as the /built API call - http://projects.theforeman.org/issues/1930 -
      # which we need to do before rebooting, lest the machine go into a reinstall
      # loop if it is configured to boot on PXE):
      mount LABEL=ROOT /mnt
      /usr/bin/docker run \
          --name puppet-certreq \
          --net=host \
          --privileged \
          -v /mnt/etc/systemd:/etc/systemd \
          -v /mnt/etc/puppet:/etc/puppet \
          -v /mnt/var/lib/puppet:/var/lib/puppet \
          -v /mnt/home/core:/home/core \
          -v /mnt/etc/os-release:/etc/os-release:ro \
          -v /mnt/etc/lsb-release:/etc/lsb-release:ro \
          -v /mnt/etc/coreos:/etc/coreos:rw \
          -v /mnt/run:/run:ro \
          -v /mnt/usr/bin/systemctl:/usr/bin/systemctl:ro \
          -v /mnt/sys/fs/cgroup:/sys/fs/cgroup:ro \
          -v /mnt/etc/puppet/puppet.conf:/etc/puppet/puppet.conf:ro \
          -v /dev/ipmi0:/dev/ipmi0 \
          epflsti/puppet:latest \
          agent -t
          
      # All done
      wget -q -O /dev/null --no-check-certificate <%= foreman_url %>
      # reboot
