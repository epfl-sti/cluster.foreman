#!/usr/bin/perl -w

use strict;

=head1 NAME

dockerer - Build and install things under docker/

=head1 SYNOPSIS

   dockerer build <target>
   dockerer run --name=<clustername> <target>

Where C<target> is one of "foreman-base" or "foreman"

=head1 DESCRIPTION

=head2 build

=cut

use FindBin qw($Bin);
use lib "$Bin/../lib";
use Docopt;
use Pod::Usage;
use Try::Tiny;
use Net::Domain qw(hostfqdn hostdomain);
use autodie qw(:all);

our $opts;
try {
  $opts = docopt();
} catch {
  pod2usage();
};

my $target = $opts->{"<target>"};
die unless $target;

if ($opts->{run}) {
  run($target);
} elsif ($opts->{build}) {
  build($target);
} else {
  pod2usage();
}

sub plan {
}

sub build {
  my ($target) = @_;
  die "unknown build target: $target\n" unless ($target eq "foreman-base");
  system("cd '$Bin/$target' && docker build -t epflsti/$target .");
}

sub run {
  my ($target) = @_;
  die "unknown run target: $target\n" unless ($target eq "foreman");
  build("foreman-base");

  my $answers_yaml = "$Bin/../foreman-installer-answers.yaml";
  if (! -f $answers_yaml) {
    system("$Bin/../configure.pl --target-file=$answers_yaml");
  }

  die unless defined(my $clustername = $opts->{'--name'});
  my $foreman_hostname;
  if ($clustername =~ m/\./) {
    $foreman_hostname = $clustername;
  } else {
    $foreman_hostname = "${clustername}." . hostdomain;
  }
  system(<<"DOCKER_RUN");
set -e -x
docker rm $foreman_hostname || true
docker run --name=$foreman_hostname -h $foreman_hostname -v "$Bin/..":/cluster.foreman -p 8443:443 -p 8080:80 -it epflsti/foreman-base
DOCKER_RUN
}
