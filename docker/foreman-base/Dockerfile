# Dockerfile for Foreman-in-Docker, part one: the prerequisites
#
# See also ../foreman/Dockerfile for the useable version
# Built on top of Ubuntu, because why the hell not.
FROM ubuntu:latest
MAINTAINER STIIT Dev <stiitdev@groupes.epfl.ch>

# DEBIAN_FRONTEND=noninteractive avoids debconf trying to ask questions and erroring out:
# http://askubuntu.com/questions/506158/unable-to-initialize-frontend-dialog-when-using-ssh
ENV DEBIAN_FRONTEND=noninteractive 
# We remove sudo with apt-get remove, not apt-get autoremove which would complain
RUN set -e -x; apt -q update; apt -qy remove --purge sudo; apt -qy upgrade; apt -qy autoremove --purge; apt -qy install curl

# https://theforeman.org/manuals/1.15/quickstart_guide.html
RUN echo "deb http://deb.theforeman.org/ xenial 1.15" > /etc/apt/sources.list.d/foreman.list
RUN echo "deb http://deb.theforeman.org/ plugins 1.15" >> /etc/apt/sources.list.d/foreman.list
RUN curl https://deb.theforeman.org/pubkey.gpg | apt-key add -
RUN set -e -x; apt -q update ; apt -qy install ca-certificates \
  foreman \
  ruby-rubyipmi \
  ruby-foreman-discovery \
  ruby-foreman-column-view \
  ruby-foreman-templates \
  ruby-hammer-cli-foreman \
  ruby-foreman-cockpit \
  ruby-foreman-dhcp-browser \
  libyaml-perl \
  libipc-system-simple-perl \
  openssl ; \
  apt-get -y autoremove --purge

ADD foreman-ipmi/ /usr/share/foreman

# Sigh. Fix bugs in the foreman package
RUN echo "gem 'tzinfo-data'" >> /usr/share/foreman/bundler.d/tzinfo.rb
RUN cd /usr/share/foreman; bundle install

# Add sqlite3 as the default database (unless one supplies their own /etc/foreman/database.yml)
RUN echo "gem 'sqlite3'" >> /usr/share/foreman/bundler.d/epflsti.rb
RUN set -e -x; apt-get -y install libsqlite3-dev build-essential; cd /usr/share/foreman; bundle install; apt-get -y remove --purge libsqlite3-dev build-essential; apt -qy remove --purge sudo; apt-get -y autoremove --purge

# Commit Bundler changes
RUN cd /usr/share/foreman; bundle install

# EPFLSTI-specific code and customizations
# We keep these at the bottom so that if you don't want these, you
# still benefit from intermediate layers built up to here.
ADD foreman_column_view.yaml /etc/foreman/plugins/foreman_column_view.yaml
ADD ignored_environments.yml /usr/share/foreman/config/ignored_environments.yml
# Add our own /ipmi/index mini-app
WORKDIR /usr/share/foreman
RUN perl -i -pe 'm/Foreman::Application\.routes\.draw/ || next; \
  print; $seen = 1; $_ = qq{  get "ipmi/index"\n\n}; END { die unless $seen }' config/routes.rb

# Example configuration files
# User is expected to override these in the VOLUMEs and (re)start the container
# Bogus credentials and secrets are auto-generated by init.pl instead
  
# Finalize the image.
WORKDIR /
ADD init.pl /
RUN chmod 0755 /init.pl
VOLUME "/etc/foreman"
VOLUME "/etc/ssl/certs"
CMD ["/init.pl"]
